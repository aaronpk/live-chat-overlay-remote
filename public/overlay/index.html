<html>
<link rel="stylesheet" href="assets/youtube-chat.css">
<script src="assets/jquery.js"></script>
<script src="assets/pushstream.js"></script>
<style>
</style>
<body>

<highlight-chat></highlight-chat>

</body>
<script>

// Wait for streaming data
var pushstream = new PushStream({
  host: window.location.hostname,
  port: 443,
  useSSL: true,
  modes: "eventsource",
  urlPrefixEventsource: "/overlay/sub",
  channelsByArgument: true,
  channelsArgument: "id"
});
pushstream.onmessage = function(data,id,channel) {

  switch(data.command) {

    case 'show':
      hideMessageImmediately();
      showMessage(data);
      if(data.config) {
        loadConfig(data.config);
      }
      break;

    case 'hide':
      hideMessage();
      break;

  }

}

var channel = window.location.hash.replace("#","");
pushstream.addChannel(channel);
pushstream.connect();


function showMessage(data, hideAfterDelay=0) {
  var message = $( "highlight-chat" ).removeClass("preview").append(data.html)
  .delay(10).queue(function(next){
    $( ".hl-c-cont" ).removeClass("fadeout");
    next();
  });
  if(hideAfterDelay) {
    message.delay(hideAfterDelay).queue(function(next){
      $(".hl-c-cont").addClass("fadeout").delay(300).queue(function(){
        $(".hl-c-cont").remove().dequeue();
      });
      next();
    });
  }
}

function hideMessageImmediately() {
  $(".hl-c-cont").remove();
}

function hideMessage() {
  $(".hl-c-cont").addClass("fadeout").delay(300).queue(function(){
    $(".hl-c-cont").remove().dequeue();
  });
}

function loadConfig(config) {
  let root = document.documentElement;
  root.style.setProperty("--keyer-bg-color", config.color);

  if(config.authorBackgroundColor) {
    root.style.setProperty("--author-bg-color", config.authorBackgroundColor);
    root.style.setProperty("--author-avatar-border-color", config.authorBackgroundColor);
  }
  if(config.authorAvatarBorderColor) {
    root.style.setProperty("--author-avatar-border-color", config.authorAvatarBorderColor);
  }
  if(config.commentBackgroundColor) {
    root.style.setProperty("--comment-bg-color", config.commentBackgroundColor);
  }
  if(config.authorColor) {
    root.style.setProperty("--author-color", config.authorColor);
  }
  if(config.commentColor) {
    root.style.setProperty("--comment-color", config.commentColor);
  }
  if(config.fontFamily) {
    root.style.setProperty("--font-family", config.fontFamily);
  }
  if(config.scale) {
    root.style.setProperty("--comment-scale", config.scale);
  }
  if(config.commentBottom) {
    root.style.setProperty("--comment-area-bottom", config.commentBottom);
  }
  if(config.commentHeight) {
    root.style.setProperty("--comment-area-height", config.commentHeight);
  }
  if(config.sizeOffset) {
    root.style.setProperty("--comment-area-size-offset", config.sizeOffset);
  }

}

</script>
</html>
